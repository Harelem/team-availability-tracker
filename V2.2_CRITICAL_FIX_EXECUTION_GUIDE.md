# V2.2 Critical Fix Execution Guide

**URGENT - Execute Before Deployment**  
**Estimated Time:** 15-20 minutes  
**Risk Level:** CRITICAL - Production blocking issues

---

## Quick Command Execution

### Step 1: Execute Database Schema Fixes (CRITICAL)
```bash
# Execute the critical schema fixes immediately
cd /Users/harel/team-availability-tracker
psql -d your_database_url -f sql/v2.2-critical-schema-fixes.sql
```

### Step 2: Verify Fix Success
```bash
# Check that enhanced sprint view is working
psql -d your_database_url -c "SELECT sprint_number, start_date, end_date, is_current FROM current_enhanced_sprint;"

# Should return: Sprint 2, 2025-08-10, 2025-08-23, true
```

### Step 3: Update Application Cache Settings
Edit `/src/utils/dataConsistencyManager.ts`:

```typescript
// CHANGE THIS (Line 39):
cacheKey.includes('global_sprint') ||

// TO THIS:
// Remove global_sprint from static data - move to dynamic

// AND ADD THIS to isDynamicData function (Line 47):
cacheKey.includes('global_sprint') ||
```

### Step 4: Test Application
```bash
# Start development server and test COO dashboard
npm run dev

# Navigate to COO dashboard and verify:
# - Sprint shows as "Sprint 2" 
# - Sprint dates show Aug 10-23, 2025
# - Sprint progress shows current percentage
# - No console errors about missing enhanced_sprint tables
```

---

## Critical Issues Fixed

✅ **Missing Enhanced Sprint Tables** - Created `current_enhanced_sprint` view  
✅ **Expired Sprint Data** - Updated to Sprint 2 (Aug 10-23, 2025)  
✅ **Performance Indexes** - Removed 3 redundant indexes  
✅ **Cache Duration** - Instructions to fix 2-hour sprint cache  

---

## Validation Checklist

Before deployment, confirm:

- [ ] Enhanced sprint view returns data: `SELECT * FROM current_enhanced_sprint;`
- [ ] Sprint shows as active: `is_current = true`
- [ ] Current date falls within sprint range
- [ ] COO dashboard loads without errors
- [ ] Team calculations show correct sprint data
- [ ] No TypeScript compilation errors

---

## Emergency Rollback (If Needed)

```sql
-- If anything goes wrong, rollback sprint data:
UPDATE global_sprint_settings 
SET 
    current_sprint_number = 1,
    sprint_start_date = '2025-07-27',
    updated_by = 'ROLLBACK'
WHERE id = (SELECT MAX(id) FROM global_sprint_settings);

-- Drop enhanced view if causing issues:
DROP VIEW IF EXISTS current_enhanced_sprint;
```

---

## Post-Fix Monitoring

Monitor these metrics after deployment:

1. **COO Dashboard Load Time** - Should be <2 seconds
2. **Sprint Calculation Consistency** - All services return same sprint data  
3. **Cache Hit Rate** - Should be >80% for frequently accessed data
4. **Error Logs** - No more "missing enhanced_sprint" errors

---

## Contact Information

**Issue:** Enhanced sprint tables missing  
**Fix:** Execute `sql/v2.2-critical-schema-fixes.sql`

**Issue:** Sprint data still expired  
**Fix:** Verify update query in Section 2 of SQL script

**Issue:** COO dashboard errors  
**Fix:** Check browser console for specific TypeScript errors

---

**DEPLOYMENT STATUS: BLOCKED until all fixes are applied and validated**

Execute these fixes immediately before any production deployment attempt.